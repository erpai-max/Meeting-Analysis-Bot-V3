<!-- dashboard.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Meeting Insights Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f3f4f6; margin:20px; color:#111827; }
    .card { background:#fff; border-radius:10px; padding:16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); margin-bottom:16px; }
    input, select { padding:8px; border-radius:6px; border:1px solid #e5e7eb; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:8px 10px; border-bottom:1px solid #e6e6e6; text-align:left; vertical-align:top; }
    th { background:#f9fafb; font-weight:600; position:sticky; top:0; z-index:1; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    .small { font-size:12px; color:#6b7280; }
    .download-btn { background:#4f46e5; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 8px 0">Meeting Insights Dashboard</h2>
    <div class="controls">
      <input id="search" placeholder="Search (POC, Society, Owner, Manager...)" style="flex:1;" />
      <select id="managerFilter"><option value="">All Managers</option></select>
      <button id="downloadCsv" class="download-btn">Download CSV</button>
    </div>
    <div id="summary" class="small"></div>
  </div>

  <div id="tableWrap" class="card" style="overflow:auto; max-height:70vh;">
    <table id="resultsTable">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
async function loadData() {
  try {
    const resp = await fetch('dashboard_data.json');
    if (!resp.ok) throw new Error('dashboard_data.json not found or not accessible');
    const data = await resp.json();
    render(data);
  } catch (err) {
    document.getElementById('tableWrap').innerHTML = '<div style="padding:20px;color:#b91c1c;">Error loading dashboard_data.json: ' + err.message + '</div>';
  }
}

function render(data) {
  if (!Array.isArray(data) || data.length === 0) {
    document.getElementById('tableWrap').innerHTML = '<div style="padding:20px;">No records found.</div>';
    return;
  }

  // Use keys from first record as columns (preserves order if JSON was written orderly)
  const cols = Object.keys(data[0]);
  const thead = document.getElementById('thead');
  thead.innerHTML = '<tr>' + cols.map(c => '<th>' + escapeHtml(c) + '</th>').join('') + '</tr>';

  // populate manager filter
  const managers = Array.from(new Set(data.map(r => (r.Manager || '').trim()).filter(Boolean))).sort();
  const managerFilter = document.getElementById('managerFilter');
  managers.forEach(m => managerFilter.appendChild(new Option(m, m)));

  // caching data for filtering
  window._dashboardData = data;
  window._cols = cols;
  updateTable();

  // summary
  document.getElementById('summary').textContent = `${data.length} records loaded.`;
}

function escapeHtml(s) {
  return (s===null || s===undefined) ? '' : String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

function updateTable() {
  const q = (document.getElementById('search').value || '').toLowerCase();
  const manager = document.getElementById('managerFilter').value;
  const data = (window._dashboardData || []).filter(r => {
    if (manager && (r.Manager || '') !== manager) return false;
    if (!q) return true;
    // search in a few important fields
    return (String(r["Society Name"] || '') + ' ' + String(r["POC Name"] || '') + ' ' + String(r["Owner (Who handled the meeting)"] || '') + ' ' + String(r.Manager || '')).toLowerCase().includes(q);
  });

  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  const cols = window._cols || [];
  for (const row of data) {
    const tr = document.createElement('tr');
    for (const c of cols) {
      const td = document.createElement('td');
      td.innerHTML = escapeHtml(row[c] || '');
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

function toCSV(rows, cols) {
  const escape = s => '"' + String(s || '').replace(/"/g, '""') + '"';
  const header = cols.map(escape).join(',');
  const lines = rows.map(r => cols.map(c => escape(r[c])).join(','));
  return [header].concat(lines).join('\r\n');
}

document.getElementById('search').addEventListener('input', updateTable);
document.getElementById('managerFilter').addEventListener('change', updateTable);

document.getElementById('downloadCsv').addEventListener('click', () => {
  const cols = window._cols || [];
  const q = (document.getElementById('search').value || '').toLowerCase();
  const manager = document.getElementById('managerFilter').value;
  const rows = (window._dashboardData || []).filter(r => {
    if (manager && (r.Manager || '') !== manager) return false;
    if (!q) return true;
    return (String(r["Society Name"] || '') + ' ' + String(r["POC Name"] || '') + ' ' + String(r["Owner (Who handled the meeting)"] || '') + ' ' + String(r.Manager || '')).toLowerCase().includes(q);
  });
  const csv = toCSV(rows, cols);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'dashboard_data.csv';
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

loadData();
</script>
</body>
</html>
