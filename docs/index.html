<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Meeting Analysis Report</title>

  <!-- UI & libs (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    @keyframes gradient-animation{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    :root{
      --bg-start:#f5f7fa;--bg-end:#c3cfe2;--text-1:#1e293b;--text-2:#475569;--text-3:#64748b;
      --card:rgba(255,255,255,.85);--card-brd:rgba(255,255,255,.2);--inp:#fff;--inp-text:#1e293b;--inp-brd:#cbd5e1;
      --tab:rgba(226,232,240,.7);--tab-text:#334155;--grid:rgba(0,0,0,.1);--overlay:rgba(0,0,0,.5);
      --chat-user:#dbeafe;--chat-bot:#e2e8f0
    }
    .dark{
      --bg-start:#0f172a;--bg-end:#334155;--text-1:#f1f5f9;--text-2:#cbd5e1;--text-3:#94a3b8;
      --card:rgba(30,41,59,.6);--card-brd:rgba(255,255,255,.1);--inp:#334155;--inp-text:#f1f5f9;--inp-brd:#475569;
      --tab:rgba(51,65,85,.7);--tab-text:#cbd5e1;--grid:rgba(71,85,105,.5);--overlay:rgba(0,0,0,.7);
      --chat-user:#1e40af;--chat-bot:#334155
    }
    body{font-family:'Inter',sans-serif;background:linear-gradient(-45deg,var(--bg-start),var(--bg-end));background-size:400% 400%;animation:gradient-animation 15s ease infinite;color:var(--text-1);}
    .card{background:var(--card);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--card-brd);border-radius:1rem;box-shadow:0 8px 32px rgba(0,0,0,.25)}
    input,select,textarea{background:var(--inp)!important;color:var(--inp-text)!important;border-color:var(--inp-brd)!important}
    .tab-btn{padding:.75rem 1.25rem;border-radius:9999px;font-weight:600;background:var(--tab);color:var(--tab-text);border:1px solid transparent}
    .tab-btn.active{background:linear-gradient(to right,#0ea5e9,#2563eb);color:#fff;box-shadow:0 4px 14px rgba(0,118,255,.39)}
    .tab{display:none}.tab.active{display:block}
    .chart-wrap{position:relative;width:100%;height:400px;max-height:60vh}
    .loader{border:4px solid #475569;border-top:4px solid #38bdf8;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .modal{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:var(--overlay);z-index:50}
    .modal.show{display:flex}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:.5rem .75rem}

    /* === Chatbot: UI === */
    .chat-fab{position:fixed;right:18px;bottom:18px;background:#0ea5e9;color:#fff;border:none;
      width:56px;height:56px;border-radius:50%;font-size:22px;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,.3);z-index:60}
    .chat-panel{position:fixed;right:18px;bottom:86px;width:340px;max-width:90vw;background:#121826;
      color:#e8eef6;border:1px solid #1e304a;border-radius:14px;display:none;flex-direction:column;overflow:hidden;z-index:60}
    .chat-head{padding:10px 12px;background:#101828;border-bottom:1px solid #1e304a;display:flex;justify-content:space-between;align-items:center}
    .chat-body{height:360px;overflow:auto;padding:10px}
    .chat-row{margin:8px 0;display:flex}
    .chat-bot{background:#0d2137;border:1px solid #244261;border-radius:10px;padding:8px 10px;max-width:85%; word-wrap: break-word;}
    .chat-user{background:#214c76;border:1px solid #3a6c96;border-radius:10px;padding:8px 10px;margin-left:auto;max-width:85%; word-wrap: break-word;}
    .chat-foot{display:flex;gap:6px;padding:10px;border-top:1px solid #1e304a;background:#101828}
    .chat-foot input{flex:1;padding:10px;border-radius:10px;border:1px solid #1e304a;background:#0d1422;color:#e8eef6}
    .chat-foot button{padding:10px 12px;border-radius:10px;border:1px solid #244261;background:#183150;color:#bfe1ff;cursor:pointer}
  </style>
</head>
<body class="dark">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-8 relative">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div>
          <h1 class="text-3xl font-bold">Sales Meeting Analysis Report</h1>
          <p class="text-[var(--text-2)]">Live dashboard from Google Sheet export</p>
          <p id="updated" class="text-xs text-[var(--text-3)] mt-1">‚Äì</p>
        </div>
        <button id="theme" class="p-2 rounded-full card" title="Toggle theme">üåì</button>
      </div>
    </header>

    <nav class="flex flex-wrap justify-center gap-2 md:gap-3 mb-6">
      <button class="tab-btn active" data-tab="tab-summary">üìà Executive Summary</button>
      <button class="tab-btn" data-tab="tab-team">üèÜ Team & Product</button>
      <button class="tab-btn" data-tab="tab-deal">üí∞ Deal Analysis</button>
      <button class="tab-btn" data-tab="tab-individual">üöÄ Individual Deep Dive</button>
      <button class="tab-btn" data-tab="tab-risk">‚ö†Ô∏è Risk & Tools</button>
    </nav>

    <!-- Executive Summary -->
    <section id="tab-summary" class="tab active">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card p-5 text-center"><div class="text-sm text-[var(--text-3)]">Total Pipeline</div><div id="k_pipe" class="text-3xl font-bold text-sky-400 mt-1">‚Äî</div></div>
        <div class="card p-5 text-center"><div class="text-sm text-[var(--text-3)]">Avg % Score</div><div id="k_avg" class="text-3xl font-bold text-sky-400 mt-1">‚Äî</div></div>
        <div class="card p-5 text-center"><div class="text-sm text-[var(--text-3)]">Total Meetings</div><div id="k_total" class="text-3xl font-bold text-sky-400 mt-1">‚Äî</div></div>
        <div class="card p-5 text-center"><div class="text-sm text-[var(--text-3)]">Win / Lost / Open</div><div id="k_deals" class="text-3xl font-bold text-sky-400 mt-1">‚Äî</div></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-3">Sales Funnel</h3>
          <div id="funnel" class="flex items-center gap-3"></div>
        </div>
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-3">Meetings by Type</h3>
          <div class="chart-wrap"><canvas id="chartType"></canvas></div>
        </div>
      </div>
    </section>

    <!-- Team & Product -->
    <section id="tab-team" class="tab">
      <div class="card p-5 mb-6">
        <h3 class="font-semibold text-lg mb-3">üèÜ Team Leaderboard</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="sticky top-0 bg-[var(--card)] border-b border-[var(--inp-brd)]">
              <tr class="text-[var(--text-3)]">
                <th class="p-2">Team</th><th class="p-2">Avg. % Score</th><th class="p-2">Meetings</th><th class="p-2">Pipeline (‚Çπ)</th>
              </tr>
            </thead>
            <tbody id="teamBody"></tbody>
          </table>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-3">Performance by Product</h3>
          <div class="chart-wrap"><canvas id="chartProduct"></canvas></div>
        </div>
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-3">Visit Type Effectiveness</h3>
          <div class="chart-wrap"><canvas id="chartVisit"></canvas></div>
        </div>
      </div>
    </section>

    <!-- Deal Analysis -->
    <section id="tab-deal" class="tab">
      <div class="card p-5">
        <h3 class="font-semibold text-lg mb-3">Deal Value vs. Meeting % Score</h3>
        <p class="text-sm text-[var(--text-3)] mb-3">Checks correlation of meeting quality with value</p>
        <div class="chart-wrap"><canvas id="chartScatter"></canvas></div>
      </div>
    </section>

    <!-- Individual Deep Dive -->
    <section id="tab-individual" class="tab">
      <div class="card p-5 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
          <select id="selOwner" class="p-3 rounded-lg border"></select>
          <div class="flex gap-2 items-center">
            <input id="start" type="date" class="p-2 rounded-lg border w-full">
            <span class="text-[var(--text-3)]">to</span>
            <input id="end" type="date" class="p-2 rounded-lg border w-full">
          </div>
          <select id="selStatus" class="p-3 rounded-lg border">
            <option value="">All Deal Statuses</option>
            <option>Pending</option><option>Live</option><option>Conflict</option><option>Win</option><option>Lost</option>
          </select>
        </div>
      </div>

      <div id="indivKpis" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"></div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-3">üåü Best Meeting</h3>
          <div id="bestBox" class="text-sm"></div>
        </div>
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-3">üìã Action Items (from notes)</h3>
          <div id="actionsBox" class="text-sm"></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-3">Common Improvement Areas</h3>
          <ul id="listImprove" class="list-disc pl-5 text-sm space-y-1"></ul>
        </div>
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-3">Key Strengths & Positives</h3>
          <ul id="listPositive" class="list-disc pl-5 text-sm space-y-1"></ul>
        </div>
        <div class="card p-5">
          <h3 class="font-semibold text-lg mb-3">Missed Opportunities</h3>
          <ul id="listMissed" class="list-disc pl-5 text-sm space-y-1"></ul>
        </div>
      </div>

      <div class="flex justify-center mt-8">
        <button id="btnExcel" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">üì• Download Excel</button>
      </div>
    </section>

    <!-- Risk & Tools -->
    <section id="tab-risk" class="tab">
      <div class="card p-5">
        <h3 class="font-semibold text-lg mb-3">Risk Dashboard</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
          <select id="riskOwner" class="p-3 rounded-lg border"><option value="">All Owners</option></select>
          <select id="riskSociety" class="p-3 rounded-lg border"><option value="">All Societies</option></select>
        </div>
        <div class="overflow-x-auto max-h-96">
          <table class="w-full text-left text-sm">
            <thead class="sticky top-0 bg-[var(--card)] border-b border-[var(--inp-brd)]">
              <tr class="text-[var(--text-3)]"><th class="p-2">Date</th><th class="p-2">Owner</th><th class="p-2">Society</th><th class="p-2">Risk / Issue</th></tr>
            </thead>
            <tbody id="riskBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Meeting modal -->
  <div id="modal" class="modal"><div class="card p-6 max-w-xl w-[92%]">
    <div class="flex justify-between items-center mb-3">
      <h2 id="mTitle" class="text-xl font-bold">Meeting</h2>
      <button id="mClose" class="text-2xl leading-none">√ó</button>
    </div>
    <div id="mBody" class="kv text-sm"></div>
  </div></div>

  <!-- === Chatbot trigger + panel === -->
  <button class="chat-fab" id="chatToggle" aria-label="Open chatbot">üí¨</button>

  <div class="chat-panel" id="chatPanel" aria-live="polite" aria-label="InsightBot chat">
    <div class="chat-head">
      <strong>InsightBot</strong>
      <button id="chatClose" title="Close" style="background:none;color:#8ea0b3;border:none;font-size:18px;cursor:pointer">√ó</button>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="chat-row"><div class="chat-bot">Hi! Ask me about meetings, risks, scores, or pricing steps. I‚Äôll answer using your latest dashboard data.</div></div>
    </div>
    <div class="chat-foot">
      <input id="chatInput" placeholder="Type your question‚Ä¶" aria-label="Chat input" />
      <button id="chatSend">Send</button>
    </div>
  </div>

  <script>
  /* ===== Config ===== */
  // The CHAT_API endpoint should point to your Flask backend.
  // If running locally, this relative URL is usually correct.
  const CHAT_API = '/chat';

  /* ===== Utilities ===== */
  const INR = n => '‚Çπ ' + Math.round(n).toLocaleString('en-IN');
  const num = v => { if (v == null) return 0; const m = String(v).replace(/‚Çπ/g,'').match(/-?\d[\d,]*\.?\d*/); return m ? parseFloat(m[0].replace(/,/g,'')) : 0; };
  const pct = v => { if (v == null || v === '') return NaN; const s = String(v).trim(); let x = NaN; if (s.endsWith('%')) x = parseFloat(s.replace('%','')); else x = parseFloat(s); return isFinite(x) ? x : NaN; };
  const by = k => (a,b)=> String(a[k]||'').localeCompare(String(b[k]||''));
  const uniq = (rows,key) => Array.from(new Set(rows.map(r => (r[key]||'').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  const el = id => document.getElementById(id);

  /* ===== Robust amount resolver ===== */
  const AMT_KEYS = ['Amount Value','Amount','Deal Amount','Deal Value','Amount (INR)','Amount INR','Amount (‚Çπ)','Value (‚Çπ)','Pipeline Value','Quoted Amount'];
  function amt(r){
    for (const k of AMT_KEYS){
      if (k in r && r[k] != null && String(r[k]).trim() !== ''){
        const n = num(r[k]);
        if (isFinite(n) && n > 0) return n;
      }
    }
    for (const [k,v] of Object.entries(r||{})){
      if (/\b(amount|value|deal|pipeline)\b/i.test(k)){
        const n = num(v);
        if (isFinite(n) && n > 0) return n;
      }
    }
    return 0;
  }

  /* ===== State ===== */
  let ALL = [];
  let charts = {};
  // --- CHATBOT UPDATE ---
  // Generate a unique session ID for this user's visit.
  let chatSessionId = crypto.randomUUID();

  /* ===== Load data ===== */
  async function loadData(){
    // FIX: The `fetch` call for 'dashboard_data.json' was failing because the file
    // was not available at that relative path in the execution environment.
    // To make this a self-contained, runnable example, sample data has been
    // embedded directly into the script.
    const sampleData = [
        {
            "Date": "2025-09-26",
            "Owner (Who handled the meeting)": "Rohan Sharma",
            "Manager": "Priya Singh",
            "Team": "North India Sales",
            "Society Name": "DLF Crest",
            "POC Name": "Mr. Gupta",
            "Deal Status": "Live",
            "% Score": "88%",
            "Amount Value": 1200000,
            "Risks / Unresolved Issues": "Competitor bid is slightly lower.",
            "Missed Opportunities": "Forgot to mention the new AI security feature.",
            "Improvement Areas": "Need to be more aggressive on closing.",
            "Positive Factors": "Strong relationship with the society chairman.",
            "Action items": "Schedule a follow-up demo for the committee.",
            "Meeting Type": "Sales",
            "Product Pitch": "Enterprise Security Suite",
            "Visit Type": "On-site"
        },
        {
            "Date": "2025-09-25",
            "Owner (Who handled the meeting)": "Sneha Reddy",
            "Manager": "Anil Kumar",
            "Team": "South India Sales",
            "Society Name": "Prestige Shantiniketan",
            "POC Name": "Ms. Iyer",
            "Deal Status": "Win",
            "% Score": "95%",
            "Amount Value": 850000,
            "Risks / Unresolved Issues": "",
            "Missed Opportunities": "",
            "Improvement Areas": "",
            "Positive Factors": "Offered a limited-time discount which sealed the deal.",
            "Action items": "Initiate onboarding process.",
            "Meeting Type": "Sales",
            "Product Pitch": "Community Management Plus",
            "Visit Type": "Virtual"
        },
        {
            "Date": "2025-09-24",
            "Owner (Who handled the meeting)": "Amit Patel",
            "Manager": "Sunita Desai",
            "Team": "West India Sales",
            "Society Name": "Lodha Palava",
            "POC Name": "Mr. Shah",
            "Deal Status": "Lost",
            "% Score": "60%",
            "Amount Value": 950000,
            "Risks / Unresolved Issues": "Client was not convinced about the ROI.",
            "Missed Opportunities": "Failed to adequately address competitor's claims.",
            "Improvement Areas": "Better objection handling is required.",
            "Positive Factors": "Initial interest was high.",
            "Action items": "Mark as lost, schedule a feedback call in 3 months.",
            "Meeting Type": "Sales",
            "Product Pitch": "Enterprise Security Suite",
            "Visit Type": "On-site"
        },
        {
            "Date": "2025-09-23",
            "Owner (Who handled the meeting)": "Rohan Sharma",
            "Manager": "Priya Singh",
            "Team": "North India Sales",
            "Society Name": "Godrej South Estate",
            "POC Name": "Mr. Verma",
            "Deal Status": "Pending",
            "% Score": "75%",
            "Amount Value": 1500000,
            "Risks / Unresolved Issues": "Budget approval is pending from their finance team.",
            "Missed Opportunities": "",
            "Improvement Areas": "Follow up more consistently.",
            "Positive Factors": "Product demo was very well received.",
            "Action items": "Send a weekly follow-up email.",
            "Meeting Type": "Sales",
            "Product Pitch": "Smart Society Automation",
            "Visit Type": "Virtual"
        },
        {
            "Date": "2025-09-22",
            "Owner (Who handled the meeting)": "Sneha Reddy",
            "Manager": "Anil Kumar",
            "Team": "South India Sales",
            "Society Name": "Sobha Dream Acres",
            "POC Name": "Mr. Menon",
            "Deal Status": "Live",
            "% Score": "82%",
            "Amount Value": 780000,
            "Risks / Unresolved Issues": "",
            "Missed Opportunities": "",
            "Improvement Areas": "",
            "Positive Factors": "Client is very impressed with our support structure.",
            "Action items": "Send the final contract for review.",
            "Meeting Type": "Service",
            "Product Pitch": "Community Management Plus",
            "Visit Type": "On-site"
        },
        {
            "Date": "2025-09-21",
            "Owner (Who handled the meeting)": "Vikram Singh",
            "Manager": "Priya Singh",
            "Team": "North India Sales",
            "Society Name": "Tata Primanti",
            "POC Name": "Mrs. Kaur",
            "Deal Status": "Conflict",
            "% Score": "55%",
            "Amount Value": 1100000,
            "Risks / Unresolved Issues": "Disagreement within the committee on which vendor to choose.",
            "Missed Opportunities": "Could not get all decision-makers in one meeting.",
            "Improvement Areas": "Stakeholder mapping before the main presentation.",
            "Positive Factors": "Our technical features are superior.",
            "Action items": "Try to schedule a meeting with the entire committee.",
            "Meeting Type": "Sales",
            "Product Pitch": "Smart Society Automation",
            "Visit Type": "On-site"
        },
        {
            "Date": "2025-09-20",
            "Owner (Who handled the meeting)": "Amit Patel",
            "Manager": "Sunita Desai",
            "Team": "West India Sales",
            "Society Name": "Hiranandani Gardens",
            "POC Name": "Mr. Joshi",
            "Deal Status": "Win",
            "% Score": "98%",
            "Amount Value": 2200000,
            "Risks / Unresolved Issues": "",
            "Missed Opportunities": "",
            "Improvement Areas": "",
            "Positive Factors": "Excellent negotiation and rapport building.",
            "Action items": "Celebrate with the team and start deployment.",
            "Meeting Type": "Sales",
            "Product Pitch": "Smart Society Automation",
            "Visit Type": "Virtual"
        }
    ];

    ALL = sampleData;
    el('updated').textContent = 'Updated ' + new Date().toLocaleString();
    return Promise.resolve(); // Maintain async behavior for compatibility.
  }

  /* ===== Theme & Tabs ===== */
  function initTheme(){
    const saved = localStorage.getItem('theme') || 'dark';
    document.body.classList.toggle('dark', saved === 'dark');
    el('theme').onclick = () => {
      const dark = !document.body.classList.contains('dark');
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', dark ? 'dark' : 'light');
      renderAll(); // Re-render charts with new theme colors
    };
  }
  function initTabs(){
    document.querySelectorAll('.tab-btn').forEach(b=>{
      b.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        el(b.dataset.tab).classList.add('active');
        // A small delay ensures the tab is visible before chart rendering
        setTimeout(()=>renderAll(), 50);
      };
    });
  }

  /* ===== Executive Summary ===== */
  function renderSummary(){
    const total = ALL.length;
    const avg = avgOf(ALL.map(r=>pct(r['% Score'])));
    const pipe = ALL.reduce((s,r)=> s + amt(r), 0);
    el('k_total').textContent = total;
    el('k_avg').textContent = isFinite(avg)? avg.toFixed(1)+'%' : '‚Äî';
    el('k_pipe').textContent = INR(pipe);

    const win = ALL.filter(r=>String(r['Deal Status']||'').toLowerCase().includes('win')).length;
    const lost = ALL.filter(r=>String(r['Deal Status']||'').toLowerCase().includes('lost')).length;
    const open = ALL.filter(r=>{
      const s = String(r['Deal Status']||'').toLowerCase();
      return s && !s.includes('win') && !s.includes('lost');
    }).length;
    el('k_deals').textContent = `${win}/${lost}/${open}`;

    // Funnel
    const stages = {Pending:0, Live:0, Conflict:0, Win: 0, Lost: 0};
    ALL.forEach(r=>{const s = String(r['Deal Status']||''); if (stages.hasOwnProperty(s)) stages[s]++});
    const colors = {Pending:'bg-yellow-500', Live:'bg-sky-500', Conflict:'bg-red-500', Win: 'bg-green-500', Lost: 'bg-slate-600'};
    el('funnel').innerHTML = Object.entries(stages)
      .map(([k,v])=>`<div class="text-center p-4 rounded-lg flex-1 ${colors[k]} text-white shadow-md">
        <div class="text-2xl font-bold">${v}</div><div class="text-sm font-semibold">${k}</div></div>`)
      .join('<div class="text-2xl font-bold text-[var(--text-3)] flex items-center">‚Üí</div>');

    // Meetings by type
    const sales = ALL.filter(r=>/sales/i.test(r['Meeting Type']||'')).length;
    const service = ALL.filter(r=>/service/i.test(r['Meeting Type']||'')).length;
    draw('chartType', 'doughnut', {
      labels:['Sales','Service'],
      datasets:[{data:[sales,service], backgroundColor: ['#0ea5e9', '#6366f1']}]
    }, {cutout:'65%'});
  }

  /* ===== Team & Product ===== */
  function renderTeam(){
    const teams = uniq(ALL,'Team');
    const rows = teams.map(t=>{
      const R = ALL.filter(r=>r['Team']===t);
      const avg = avgOf(R.map(x=>pct(x['% Score'])));
      const pipe = R.reduce((s,r)=> s + amt(r), 0);
      return {team:t, meetings:R.length, avg:isFinite(avg)?avg:0, pipe};
    }).sort((a,b)=>b.pipe-a.pipe);
    el('teamBody').innerHTML = rows.map(r=>`
      <tr class="border-b border-[var(--inp-brd)] hover:bg-black/10">
        <td class="p-2 font-semibold">${r.team}</td>
        <td class="p-2">${r.avg.toFixed(1)}%</td>
        <td class="p-2">${r.meetings}</td>
        <td class="p-2">${INR(r.pipe)}</td>
      </tr>`).join('');

    // Product performance
    const prodKey = 'Product Pitch';
    const prods = uniq(ALL, prodKey);
    const dataAvg = prods.map(p=>{
      const R = ALL.filter(r=>r[prodKey]===p);
      return avgOf(R.map(x=>pct(x['% Score'])));
    });
    const dataVal = prods.map(p=>{
      const R = ALL.filter(r=>r[prodKey]===p);
      return R.reduce((s,r)=>s+amt(r),0);
    });
    draw('chartProduct','bar',{
      labels: prods,
      datasets: [
        {label:'Avg. % Score', data: dataAvg, yAxisID:'y', backgroundColor: '#0ea5e9'},
        {label:'Total Value (‚Çπ)', data: dataVal, yAxisID:'y1', backgroundColor: '#818cf8'}
      ]
    }, { scales: { y: {title:{display:true,text:'% Score'}, suggestedMax:100}, y1: {type:'linear', position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'Value'}}}});

    // Visit type effectiveness
    const visits = uniq(ALL, 'Visit Type');
    const visitAvg = visits.map(v=>{
      const R = ALL.filter(r=>r['Visit Type']===v);
      return avgOf(R.map(x=>pct(x['% Score'])));
    });
    draw('chartVisit','bar',{labels:visits, datasets:[{label:'Avg. % Score', data:visitAvg, backgroundColor: '#2563eb'}]});
  }

  /* ===== Deal Analysis ===== */
  function renderDeal(){
    const pts = ALL.filter(r=>amt(r)>0).map(r=>({
      x: pct(r['% Score']), y: amt(r)
    })).filter(p=>isFinite(p.x)&&isFinite(p.y));

    draw('chartScatter','scatter',{datasets:[{label:'Deal',data:pts, backgroundColor: '#0ea5e9'}]},{
      scales:{ x:{title:{display:true,text:'% Score'}, suggestedMin:0, suggestedMax:100},
               y:{title:{display:true,text:'Deal Value (INR)'}}},
      // --- BUG FIX ---
      // This onClick handler is now part of the drawing options, so it gets
      // re-attached every time the chart is redrawn (e.g., after a theme change).
      onClick: (evt, els) => {
        if (els.length > 0){
          const ptIndex = els[0].index;
          const clickedPoint = pts[ptIndex];
          // Find the original data row corresponding to the clicked point
          const targetMeeting = ALL.find(r => pct(r['% Score']) === clickedPoint.x && amt(r) === clickedPoint.y);
          if (targetMeeting) {
            showMeetingModal(targetMeeting);
          }
        }
      }
    });
  }

  /* ===== Individual Deep Dive ===== */
  function initIndividualFilters(){
    const owners = uniq(ALL,'Owner (Who handled the meeting)');
    el('selOwner').innerHTML = owners.map(o=>`<option>${o}</option>`).join('');
    const societies = uniq(ALL,'Society Name');
    el('riskSociety').innerHTML = `<option value="">All Societies</option>` + societies.map(s=>`<option>${s}</option>`).join('');
    el('riskOwner').innerHTML = `<option value="">All Owners</option>` + owners.map(o=>`<option>${o}</option>`).join('');

    ['selOwner','start','end','selStatus'].forEach(id => el(id).addEventListener('change', renderIndividual));
    ['riskOwner','riskSociety'].forEach(id => el(id).addEventListener('change', renderRisk));
    el('btnExcel').onclick = downloadExcel;
  }
  function renderIndividual(){
    const owner = el('selOwner').value;
    const a = el('start').value;
    const b = el('end').value;
    const st = el('selStatus').value;

    let rows = ALL.filter(r => (r['Owner (Who handled the meeting)']||'')===owner);
    if (a) rows = rows.filter(r=> (r['Date']||'') >= a);
    if (b) rows = rows.filter(r=> (r['Date']||'') <= b);
    if (st) rows = rows.filter(r=> (r['Deal Status']||'') === st);

    const kpis = [
      {label:'Meetings', val: rows.length},
      {label:'Avg % Score', val: isFinite(avgOf(rows.map(x=>pct(x['% Score'])))) ? avgOf(rows.map(x=>pct(x['% Score']))).toFixed(1)+'%' : '‚Äî'},
      {label:'Pipeline', val: INR(rows.reduce((s,r)=>s+amt(r),0))}
    ];
    el('indivKpis').innerHTML = kpis.map(k=>`<div class="card p-5 text-center"><div class="text-sm text-[var(--text-3)]">${k.label}</div><div class="text-3xl font-bold text-sky-400 mt-1">${k.val}</div></div>`).join('');

    const best = rows.reduce((best,r)=>{
      const s = pct(r['% Score']); return (isFinite(s) && (!best || s>best._s)) ? Object.assign({_s:s}, r) : best;
    }, null);
    el('bestBox').innerHTML = best ? `
      <div class="kv">
        <div class="text-[var(--text-3)]">Society</div><div>${best['Society Name']||''}</div>
        <div class="text-[var(--text-3)]">Date</div><div>${best['Date']||''}</div>
        <div class="text-[var(--text-3)]">% Score</div><div>${pct(best['% Score']).toFixed(1)}%</div>
        <div class="text-[var(--text-3)]">Deal Status</div><div>${best['Deal Status']||''}</div>
      </div>` : '<div class="text-sm text-[var(--text-3)]">No meetings in selected range.</div>';

    const uniqList = (key) => Array.from(new Set(rows.map(r=>String(r[key]||'').trim()).filter(Boolean)));
    el('listImprove').innerHTML  = li(uniqList('Improvement Areas'));
    el('listPositive').innerHTML = li(uniqList('Positive Factors'));
    el('listMissed').innerHTML   = li(uniqList('Missed Opportunities'));

    const acts = rows.map(r=>r['Action items']).filter(Boolean);
    el('actionsBox').innerHTML = acts.length ? acts.map(x=>`<div class="p-2 bg-black/10 rounded mb-1">${x}</div>`).join('') : '<div class="text-sm text-[var(--text-3)]">None noted.</div>';
  }
  function li(arr){ return (arr.length?arr:['None']).map(x=>`<li>${x}</li>`).join(''); }

  /* ===== Risk ===== */
  function renderRisk(){
    const owner = el('riskOwner').value;
    const society = el('riskSociety').value;
    let rows = ALL.filter(r=> String(r['Risks / Unresolved Issues']||'').trim());
    if (owner) rows = rows.filter(r=> (r['Owner (Who handled the meeting)']||'')===owner);
    if (society) rows = rows.filter(r=> (r['Society Name']||'')===society);
    el('riskBody').innerHTML = rows.map(r=>`
      <tr class="border-b border-[var(--inp-brd)] hover:bg-black/10">
        <td class="p-2">${r['Date']||''}</td>
        <td class="p-2">${r['Owner (Who handled the meeting)']||''}</td>
        <td class="p-2">${r['Society Name']||''}</td>
        <td class="p-2">${r['Risks / Unresolved Issues']||''}</td>
      </tr>`).join('');
  }

  /* ===== Charts helper ===== */
  function draw(id, type, data, extraOpts={}){
    if (!el(id)) return;
    const ctx = el(id).getContext('2d');
    if (charts[id]) charts[id].destroy();
    const isDark = document.body.classList.contains('dark');
    const opts = {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ labels:{ color: isDark ? '#cbd5e1' : '#334155' } } },
      scales:{
        x:{ ticks:{ color:isDark ? '#94a3b8' : '#64748b' }, grid:{ color:getGrid() } },
        y:{ ticks:{ color:isDark ? '#94a3b8' : '#64748b' }, grid:{ color:getGrid() } }
      },
      ...extraOpts
    };
    charts[id] = new Chart(ctx, {type, data, options: opts});
  }
  function getGrid(){ return document.body.classList.contains('dark') ? 'rgba(71,85,105,.5)' : 'rgba(0,0,0,.1)'; }
  function avgOf(arr){ const xs = arr.filter(x=>isFinite(x)); return xs.length ? xs.reduce((a,b)=>a+b,0)/xs.length : NaN; }

  /* ===== Excel Download ===== */
  function downloadExcel(){
    const owner = el('selOwner').value;
    const a = el('start').value;
    const b = el('end').value;
    let rows = ALL.filter(r => (r['Owner (Who handled the meeting)']||'')===owner);
    if (a) rows = rows.filter(r=> (r['Date']||'') >= a);
    if (b) rows = rows.filter(r=> (r['Date']||'') <= b);

    if (rows.length === 0) {
        alert("No data available for the selected filters to download.");
        return;
    }

    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws1, "Weekly Report");

    const trend = rows.map(r=>({Date:r['Date'],Society:r['Society Name'],PitchScore:r['Product Pitch Score'],Amount:amt(r)}));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(trend), "Skill Trends");

    XLSX.writeFile(wb, `Meeting_Analysis_${owner.replace(/ /g, '_')}.xlsx`);
  }

  /* ===== Modal ===== */
  el('mClose').onclick = () => el('modal').classList.remove('show');
  function showMeetingModal(meeting){
    el('mTitle').textContent = `${meeting['Date']||''} - ${meeting['Society Name']||''}`;
    el('mBody').innerHTML = `
      <div class="text-[var(--text-3)]">Owner</div><div>${meeting['Owner (Who handled the meeting)']||''}</div>
      <div class="text-[var(--text-3)]">POC</div><div>${meeting['POC Name']||''}</div>
      <div class="text-[var(--text-3)]">Deal Status</div><div>${meeting['Deal Status']||''}</div>
      <div class="text-[var(--text-3)]">% Score</div><div>${isFinite(pct(meeting['% Score'])) ? pct(meeting['% Score']).toFixed(1)+'%' : ''}</div>
      <div class="text-[var(--text-3)]">Amount</div><div>${INR(amt(meeting))}</div>
      <div class="text-[var(--text-3)]">Risks</div><div>${meeting['Risks / Unresolved Issues']||'‚Äî'}</div>`;
    el('modal').classList.add('show');
  }

  /* ===== Chatbot (InsightBot) ===== */
  function buildContextForChat(query){
    const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
    // Score rows based on how many query terms they contain
    const scored = ALL.map(r=>{
      const hay = (Object.values(r).join(' ')||'').toLowerCase();
      let score = 0; for (const t of terms){ if (hay.includes(t)) score++; }
      return { r, score };
    })
    // Filter for rows that have at least one match, sort by score, and take the top 30
    .filter(x=>x.score>0)
    .sort((a,b)=>b.score-a.score)
    .slice(0, 30);

    // Format the top-scoring rows into a concise string for the LLM
    const lines = scored.map(({r}) => [
      `Date=${r['Date']||''}`,
      `Owner=${r['Owner (Who handled the meeting)']||''}`,
      `Team=${r['Team']||''}`,
      `Society=${r['Society Name']||''}`,
      `Deal=${r['Deal Status']||''}`,
      `%Score=${r['% Score']||''}`,
      `Risks=${r['Risks / Unresolved Issues']||''}`,
    ].join(' | '));
    return lines.join('\n');
  }

  function initChatbot() {
    const chatToggle = el('chatToggle');
    const chatPanel  = el('chatPanel');
    const chatBody   = el('chatBody');
    const chatInput  = el('chatInput');
    const chatSend   = el('chatSend');
    const chatClose  = el('chatClose');

    chatToggle.addEventListener('click', ()=>{
      const isHidden = chatPanel.style.display === 'none' || chatPanel.style.display === '';
      chatPanel.style.display = isHidden ? 'flex' : 'none';
      if (isHidden) chatInput.focus();
    });
    chatClose.addEventListener('click', ()=> chatPanel.style.display='none');

    function appendBubble(text, who='bot'){
      const row = document.createElement('div');
      row.className = 'chat-row';
      const b = document.createElement('div');
      b.className = (who==='user') ? 'chat-user' : 'chat-bot';
      // Basic sanitization to prevent HTML injection
      b.textContent = text;
      row.appendChild(b);
      chatBody.appendChild(row);
      chatBody.scrollTop = chatBody.scrollHeight;
      return b; // Return the bubble element
    }

    async function sendChat(){
      const q = chatInput.value.trim();
      if (!q) return;
      chatInput.value = '';
      appendBubble(q, 'user');
      const thinkingBubble = appendBubble('Thinking‚Ä¶');

      try {
        const context = buildContextForChat(q);
        const res = await fetch(CHAT_API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          // --- CHATBOT UPDATE ---
          // Send the question, context, and the unique session ID to the backend.
          body: JSON.stringify({
            question: q,
            context: context,
            sessionId: chatSessionId
          })
        });

        if (!res.ok){
          const errData = await res.json().catch(() => ({ detail: 'Failed to get a valid error response from server.' }));
          throw new Error(errData.detail || `HTTP error! Status: ${res.status}`);
        }

        const data = await res.json();
        thinkingBubble.textContent = data.answer || 'No answer received.';
      } catch(e) {
        console.error("Chat Error:", e);
        const errorMsg = 'Error: Could not get a reply. ' + (e.message || 'Check the console for details.');
        thinkingBubble.textContent = errorMsg;
      }
    }
    chatSend.addEventListener('click', sendChat);
    chatInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); } });
  }

  /* ===== Boot ===== */
  function renderAll(){
    renderSummary();
    renderTeam();
    renderDeal();
    renderRisk();
  }

  (async function(){
    initTheme();
    initTabs();
    await loadData();

    renderAll();
    initIndividualFilters();
    renderIndividual();
    initChatbot();
  })();
  </script>
</body>
</html>

